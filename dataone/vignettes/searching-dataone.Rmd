---
title: "Searching DataONE Data Holdings"
author: "Peter Slaughter"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Searching DataONE Data Holdings}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

The primary method to locate data in the DataONE network is to use the web based search tool located at https://www.dataone.org/find-data.

Data can also be discovered programatically from R using the DataONE R client method `query()`. Both methods access the same
underlying search mechanism, the Apache Foundation Solr search engine. The DataONE Solr index (similar to a catalog or database)
contains information about every dataset that is available in the entire DataONE network. 

Information about the Solr search engine can be obtained at [Solr Resources](http://lucene.apache.org/solr/resources.html) and 
[Solr Tutorial](http://www.solrtutorial.com)

Additional information about searching DataONE can be viewed at [Content Discovery](https://mule1.dataone.org/ArchitectureDocs-current/design/SearchMetadata.html).

## Using query()

Some familiarity with Solr is necessary to use the `query()` method
effectively, however basic queries can be very powerful and the examples in this document can provide a starting point.

Additional information about the `query()` method can be obtained from the R help facility, e.g. `?query` from the R command line.

### Query and return an R list

The following example queries DataONE and return values in an R list, with each value converted from the Solr result to the appropriate R data type. Specifying 
a `CNode` instance in the `query()` parameter list causes the DataONE Coordinating Node (CN) Solr index to be searched that contains information for datasets of the entire DataONE network:


```{r}
cn <- CNode("PROD")
queryParamList <- list(q="id:doi*", rows="2", fq="abstract:chlorophyll", fl="id,title,dateUploaded,abstract,datasource,size")
result <- query(cn, queryParamList, as="list")
```

The `result` object contains all the data values returned from the query. Each element of the returned list contains information
for one dataset. Each returned attribute for a dataset can be accessed with the appropriate element name, for example, to 
access the title information of the first dataset returned, use the R statement:

```{r}
result[[1]]$title
```

To print out selected information for all returned values, use:

```{r}
ids <- lapply(result, function(x) {
  cat(sprintf("id: %s\n", x$id))
  cat(sprintf("origin member node: %s\n", x$datasource))
  cat(sprintf("title: %s\n", x$title))
  cat(sprintf("date uploaded: %s\n", x$dateUploaded))
  x$id
})
```
  
The complete list of possible values stored for a dataset can be viewed at [DataONE Solr Engine Description](https://cn.dataone.org/cn/v1/query/solr). However,
the values available for a particular dataset depend on the metadata provided when the dataset is uploaded to DataONE.

### Return values as a data frame

The following query will return a data frame, with all values stored as `character`, because `parse=FALSE` is specified:

```{r}
cn <- CNode("PROD")
queryParams <- result <- query(cn, queryParamList, as="data.frame", parse=FALSE)
result <- query(cn, queryParamList, as="data.frame", parse=FALSE)
```

Print all returned DataONE identifiers
  
```{r}
result[,'id']
```
  
### Filter query results for a specific member node

In order to limit a search to data holdings that originated from a specific member node a Solr filter query parameter (`&fq`) can be used
for the `datasource` field:

```{r}
cn <- CNode("PROD")
queryParams <- 'q=id:*&fl=id,title&fq="datasource:urn:node:KNB"&rows=5'
result <- query(cn, queryParams, as="data.frame", parse=FALSE)
result[,'id']
```
  
