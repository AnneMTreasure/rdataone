---
title: "Searching DataONE Data Holdings"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Searching DataONE Data Holdings}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

The primary method to locate data in the DataONE network is to use the web based search tool located at https://search.dataone.org.

Data can also be discovered programatically from R using the DataONE R client method `query()`. Both methods access the same
underlying search mechanism, the Apache Foundation Solr search engine that runs on the DataONE Coordinating Node (CN) located at
(https://cn.dataone.org/cn). The DataONE Solr index (similar to a catalog or database) contains infrormation for every dataset that is available from 
the DataONE network. 

Information about the Solr search engine can be obtained at [Solr Resources](http://lucene.apache.org/solr/resources.html) and 
[Solr Tutorial](http://www.solrtutorial.com)

Additional information about searching DataONE can be viewed at [Content Discovery](https://mule1.dataone.org/ArchitectureDocs-current/design/SearchMetadata.html).

## Using The `query` Method

Some familiarity with Solr is helpful to use the `query` method
effectively, however basic queries can be very powerful and the examples in this document can provide a starting point. Also, it is possible to use the `query` method just specifying name, value pairs (See the section: *A Simplied Search")


Additional information about the `query` method can be obtained from the R help facility, e.g. `?query` from the R command line.

## Query and return an R list

The following example queries DataONE and return values in an R list, with each value converted from the Solr result to the appropriate R data type: 

```{r,warning=F,message=F}
library(dataone)
cn <- CNode("PROD")
queryParamList <- list(q="id:doi*", rows="2", fq="abstract:chlorophyll", fl="id,title,dateUploaded,abstract,datasource,size")
result <- query(cn, solrQuery=queryParamList, as="list")
```

The `result` object contains all the data values returned from the query. Each element of the returned list contains information
for one dataset. Each returned attribute for a dataset can be accessed with the appropriate element name, for example, to 
access the title information of the first dataset returned, use the R statement:

```{r}
message(sprintf("Title: %s", result[[1]]$title))
```

To print out selected information for all returned values, use:

```{r}
ids <- lapply(result, function(x) {
  message(sprintf("id: %s", x$id))
  message(sprintf("origin member node: %s", x$datasource))
  message(sprintf("title: %s", x$title))
  message(sprintf("date uploaded: %s", x$dateUploaded))
  x$id
})
```
  
The complete list of possible values stored for a dataset can be viewed at [DataONE Solr Engine Description](https://cn.dataone.org/cn/v1/query/solr). However,
the values available for a particular dataset may be a subset of these, depending on the metadata provided when the dataset is uploaded to DataONE.

### Return values as a data frame
To return results as a data frame, use the `as` parameter as shown below. In addittion all values will be stored as `character`, because `parse=FALSE` is specified:

```{r,warning=F}
cn <- CNode("PROD")
result <- query(cn, queryParamList, as="data.frame", parse=FALSE)
```

The `result` is a data frame with each row containing information for one dataset. To print all returned DataONE identifiers from the result:
  
```{r}
result[,'id']
```

### Using a Simplified Search.
A search may be performed by just specifying query fields and values using the \code{'searchTerms'} parameter.
For example, to search for datasets that mention 'kelp' in the abstract and have an attribute discription that contains the word 'biomass', the following query could be used:
```{r, warning=F}
cn <- CNode("PROD")
mn <- getMNode(cn, "urn:node:mnKNB")
mySearchTerms <- list(abstract="kelp", attribute="biomass")
result <- query(cn, searchTerms=mySearchTerms, as="data.frame")
```

Using the \code{'searchTerms'} parameter causes the \code{'query'} method to construct a Solr query 
based on the list, that is passed on to the DataONE node specified.

The names in the *searchTerm* list are the query field names available from the Solr query engine
being used. These names can be determined using the *queryEngineDescription* method, or simply
navigating a web browser to the appropriate link. For the example above, the query engine
description can be found at https://knb.ecoinformatics.org/knb/d1/mn/v1/query/solr.

## Search the entire DataONE network

The DataONE Coordinating Node (CN) contains metadata about datasets from all Member Nodes in the network.
Sending a query to the CN may find matching datasets located on potentially any Member Node in the network.
The search may be limited to the data holdings of a particular MN by either specifying the "datasource"
search term in the query send to the CN, or by just sending the query to the MN of interest.

The following query shows how to query the entire DataONE network and locate and download data from 
any MN that has the desired data.
```{r,warning=F,autodep=T}
library(dataone)
cn <- CNode("PROD")
# Ask for the id, title and abstract
queryParams <- list(q="abstract:kelp", fq="attribute:abundance", fq="formatType:DATA", fl="id,title,abstract") 
result <- query(cn, solrQuery=queryParams, as="data.frame", parse=FALSE)
```


## Search just a member node
If it is known which Member Node holds the data of interest, then the search can be limited to just that
MN by sending the search directly to that MN instead of the CN. For example, if the dataset of interest
is on The Knowledge Network for Biocomplexity (KNB) Member Node, then the search is performed with the statments:
    
```{r, warning=F}
# Query the data holdings on a member node
cn <- CNode("PROD")
mn <- getMNode(cn, "urn:node:KNB")
queryParams <- list(q="abstract:habitat", fl="id,title,abstract") 
result <- query(mn, queryParams, as="data.frame", parse=FALSE)
# Choose the first matchin PID
pid <- result[1,'id']
```

### Filter query results for a specific member node
An alternative way to locate datasets on a particular node is to send the query to the CN but limit the returned results to data holdings that originated from the specific member node by using Solr filter query parameter (`&fq`) can be used
for the `datasource` field:

```{r,warning=F}
cn <- CNode("PROD")
queryParams <- 'q=id:*&fl=id,title&fq=datasource:"urn:node:KNB"&rows=5'
result <- query(cn, queryParams, as="data.frame", parse=FALSE)
result[,'id']
```
